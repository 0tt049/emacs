ELPA_IN_CORE=@ELPA_IN_CORE@
ELPA_LOCAL_PATH=@ELPA_LOCAL_PATH@
## Get this stuff from above
dirstate = .git/logs/HEAD
VCSWITNESS = $(if $(wildcard $(srcdir)/$(dirstate)),$$(srcdir)/../$(dirstate))


all:
	echo Lets build ELPA!

../lisp/elpa:
	mkdir ../lisp/elpa

../test/lisp/elpa:
	mkdir ../test/lisp/elpa

packages:
	mkdir packages

# The location of this needs to be configurable in some way
elpa-git:
	git clone --mirror https://git.savannah.gnu.org/git/emacs/elpa.git elpa-git

elpa-update: $(VCSWITNESS) elpa-git
	cd elpa-git;git fetch --all

directories: packages ../lisp/elpa ../test/lisp/elpa

.PHONY: elpa-update directories

PACKAGES=
define package_template
  packages/$(1)-$(2): elpa-update directories
	./bin/extract-package.sh -p $(1) -s $(2) $(3)

  $(1): packages/$(1)-$(2)
	$$(MAKE) -C packages/$(1)-$(2)/$(1) -f package-makefile.mk deploy PACKAGE=$(1)

  PACKAGES:=$$(PACKAGES) $(1)
endef

$(info $(call package_template,pabbrev,d28cf8632d2691dc93afbb28500126242d37961c,-e))
$(eval $(call package_template,pabbrev,d28cf8632d2691dc93afbb28500126242d37961c,-e))
$(eval $(call package_template,darkroom,73701d95133ba6581a95cec9489224b87f483cc0))
$(eval $(call package_template,queue,cf2001d3e83e05af5820174e9fa1f9638a4f8c08))


all-packages: $(PACKAGES)
	# PACKAGES $(PACKAGES)

clean:
	rm -rf packages
	rm -rf ../lisp/elpa
	rm -rf ../test/lisp/elpa
