ELPA_LOCAL_PATH=@ELPA_LOCAL_PATH@

ifdef ELPA_LOCAL_PATH
	ELPA_PATH=$(ELPA_LOCAL_PATH)
else
	ELPA_PATH=elpa-git
endif

## Get this stuff from above
dirstate = .git/logs/HEAD
VCSWITNESS = $(if $(wildcard $(srcdir)/$(dirstate)),$$(srcdir)/../$(dirstate))

all: $(ELPA_PATH)/FETCH_HEAD all-packages

../lisp/elpa:
	mkdir ../lisp/elpa

../test/lisp/elpa:
	mkdir ../test/lisp/elpa

packages:
	mkdir packages

$(ELPA_PATH):
	git clone --mirror https://git.savannah.gnu.org/git/emacs/elpa.git $(ELPA_PATH)

$(ELPA_PATH)/FETCH_HEAD: $(ELPA_PATH) Makefile
	cd $(ELPA_PATH);git fetch --all

PACKAGES=
define package_template
  packages/$(1)-$(2)/$(1):
	./bin/extract-package.sh -g $(ELPA_PATH) -p $(1) -s $(2) $(3)

  $(1): packages/$(1)-$(2)/$(1)
	$$(MAKE) -C packages/$(1)-$(2)/$(1) -f package-makefile.mk deploy PACKAGE=$(1)

  .PHONY: $(1)
  PACKAGES:=$$(PACKAGES) $(1)
endef

$(eval $(call package_template,pabbrev,d28cf8632d2691dc93afbb28500126242d37961c,-e))
$(eval $(call package_template,darkroom,73701d95133ba6581a95cec9489224b87f483cc0))
$(eval $(call package_template,queue,cf2001d3e83e05af5820174e9fa1f9638a4f8c08))


all-packages: $(PACKAGES)

clean:
	rm -rf packages
	rm -rf ../lisp/elpa
	rm -rf ../test/lisp/elpa
