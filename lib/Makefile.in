### @configure_input@

# Copyright 2017-2023 Free Software Foundation, Inc.

# This file is part of GNU Emacs.

# GNU Emacs is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.

# GNU Emacs is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.

# You should have received a copy of the GNU General Public License
# along with GNU Emacs.  If not, see <https://www.gnu.org/licenses/>.

srcdir = @srcdir@
VPATH = @srcdir@

# This is not empty if this is a Makefile that will be copied to
# xcompile/lib.
XCONFIGURE = @XCONFIGURE@

# This is required to make sure symbol visibility is correct and
# functions like readlinkat do not end up replacing their OS
# counterparts.
ANDROID_CFLAGS = @ANDROID_CFLAGS@

ifneq ($(XCONFIGURE),)

# Set vpath.  Only look for C files and some headers in srcdir:
# Headers that are generated by gnulib must be spared, or otherwise
# the versions previously built on the host will be used, if builddir
# is the same as srcdir.  Following this is a list of files in lib/
# that are not generated during the gnulib build process.  Please keep
# it up to date!

vpath _Noreturn.h $(srcdir)
vpath acl-internal.h $(srcdir)
vpath acl.h $(srcdir)
vpath af_alg.h $(srcdir)
vpath alloca.in.h $(srcdir)
vpath allocator.h $(srcdir)
vpath arg-nonnull.h $(srcdir)
vpath assert.in.h $(srcdir)
vpath attribute.h $(srcdir)
vpath binary-io.h $(srcdir)
vpath byteswap.in.h $(srcdir)
vpath c++defs.h $(srcdir)
vpath c-ctype.h $(srcdir)
vpath c-strcase.h $(srcdir)
vpath careadlinkat.h $(srcdir)
vpath cdefs.h $(srcdir)
vpath cloexec.h $(srcdir)
vpath close-stream.h $(srcdir)
vpath count-leading-zeros.h $(srcdir)
vpath count-one-bits.h $(srcdir)
vpath count-trailing-zeros.h $(srcdir)
vpath diffseq.h $(srcdir)
vpath dirent.h $(srcdir)
vpath dirent.in.h $(srcdir)
vpath dynarray.h $(srcdir)
vpath eloop-threshold.h $(srcdir)
vpath errno.in.h $(srcdir)
vpath execinfo.in.h $(srcdir)
vpath fcntl.in.h $(srcdir)
vpath filemode.h $(srcdir)
vpath filename.h $(srcdir)
vpath filevercmp.h $(srcdir)
vpath fingerprint.h $(srcdir)
vpath flexmember.h $(srcdir)
vpath fpending.h $(srcdir)
vpath fsusage.h $(srcdir)
vpath ftoastr.h $(srcdir)
vpath getopt-cdefs.in.h $(srcdir)
vpath getopt-core.h $(srcdir)
vpath getopt-ext.h $(srcdir)
vpath getopt-pfx-core.h $(srcdir)
vpath getopt-pfx-ext.h $(srcdir)
vpath getopt.in.h $(srcdir)
vpath getopt_int.h $(srcdir)
vpath gettext.h $(srcdir)
vpath idx.h $(srcdir)
vpath ieee754.in.h $(srcdir)
vpath ignore-value.h $(srcdir)
vpath intprops-internal.h $(srcdir)
vpath intprops.h $(srcdir)
vpath inttypes.in.h $(srcdir)
vpath libc-config.h $(srcdir)
vpath limits.in.h $(srcdir)
vpath malloc/dynarray.h $(srcdir)
vpath malloc/scratch_buffer.h $(srcdir)
vpath md5.h $(srcdir)
vpath min-max.h $(srcdir)
vpath mini-gmp.h $(srcdir)
vpath minmax.h $(srcdir)
vpath mktime-internal.h $(srcdir)
vpath nproc.h $(srcdir)
vpath openat-priv.h $(srcdir)
vpath openat.h $(srcdir)
vpath pathmax.h $(srcdir)
vpath regex.h $(srcdir)
vpath regex_internal.h $(srcdir)
vpath root-uid.h $(srcdir)
vpath save-cwd.h $(srcdir)
vpath scratch_buffer.h $(srcdir)
vpath sha1.h $(srcdir)
vpath sha256.h $(srcdir)
vpath sha512.h $(srcdir)
vpath sig2str.h $(srcdir)
vpath signal.in.h $(srcdir)
vpath stat-time.h $(srcdir)
vpath stdalign.in.h $(srcdir)
vpath stdckdint.in.h $(srcdir)
vpath stddef.in.h $(srcdir)
vpath stdint.in.h $(srcdir)
vpath stdio-impl.h $(srcdir)
vpath stdio.h $(srcdir)
vpath stdio.in.h $(srcdir)
vpath stdlib.in.h $(srcdir)
vpath str-two-way.h $(srcdir)
vpath strftime.h $(srcdir)
vpath string.in.h $(srcdir)
vpath sys_random.in.h $(srcdir)
vpath sys_select.in.h $(srcdir)
vpath sys_stat.in.h $(srcdir)
vpath sys_time.in.h $(srcdir)
vpath sys_types.in.h $(srcdir)
vpath tempname.h $(srcdir)
vpath time-internal.h $(srcdir)
vpath time.in.h $(srcdir)
vpath timespec.h $(srcdir)
vpath u64.h $(srcdir)
vpath unistd.in.h $(srcdir)
vpath unlocked-io.h $(srcdir)
vpath utimens.h $(srcdir)
vpath verify.h $(srcdir)
vpath vla.h $(srcdir)
vpath warn-on-use.h $(srcdir)
vpath xalloc-oversized.h $(srcdir)
vpath %.c $(srcdir)
endif

# Variables substituted by 'configure', and not autogenerated in gnulib.mk,
# or needed before gnulib.mk is included.
abs_top_srcdir = @abs_top_srcdir@
top_builddir = @top_builddir@
top_srcdir = @top_srcdir@

all:
.PHONY: all

-include ${top_builddir}/src/verbose.mk

HAVE_NATIVE_COMP = @HAVE_NATIVE_COMP@

ALL_CFLAGS = \
  $(C_SWITCH_SYSTEM) $(C_SWITCH_MACHINE) $(DEPFLAGS) \
  $(GNULIB_WARN_CFLAGS) $(WERROR_CFLAGS) $(PROFILING_CFLAGS) $(CFLAGS) \
  -I. -I../src -I$(srcdir) -I$(srcdir)/../src \
  $(if $(patsubst e-%,,$(notdir $<)),,-Demacs) $(ANDROID_CFLAGS)

ifeq ($(HAVE_NATIVE_COMP),yes)
ALL_CFLAGS += -DGL_COMPILE_CRYPTO_STREAM
endif

SYSTEM_TYPE = @SYSTEM_TYPE@
ifeq ($(SYSTEM_TYPE),windows-nt)
  include $(srcdir)/../nt/gnulib-cfg.mk
endif
include gnulib.mk
ifneq ($(SYSTEM_TYPE),windows-nt)
  libgnu_a_SOURCES += openat-die.c save-cwd.c
endif

ifeq ($(XCONFIGURE),android)
# The next line is necessary to override -I$(srcdir), which will end
# up pulling in lots of headers from the host.
ALL_CFLAGS += -I$(top_srcdir)/xcompile -I.
endif

DEPDIR = deps
ifeq ($(AUTO_DEPEND),yes)
  DEPFLAGS = -MMD -MF $(DEPDIR)/$*.d -MP
  -include $(ALLOBJS:%.o=$(DEPDIR)/%.d)
else
  DEPFLAGS =
endif

# This piece of code interferes with cross compilation
ifeq ($(XCONFIGURE),)
.PRECIOUS: ../config.status Makefile
../config.status: $(top_srcdir)/configure.ac $(top_srcdir)/m4/*.m4
	$(MAKE) -C .. $(notdir $@)
Makefile: ../config.status $(srcdir)/Makefile.in
	$(MAKE) -C .. lib/$@
endif

# Object modules that need not be built for Emacs.
# Emacs does not need e-regex.o (it has its own regex-emacs.c),
# and building it would just waste time.
# Emacs also doesn't need the dynarray-related files in malloc/ and
# the replacement 'free'.
not_emacs_OBJECTS = regex.o malloc/%.o free.o

libgnu_a_OBJECTS = fingerprint.o $(gl_LIBOBJS) \
  $(patsubst %.c,%.o,$(filter %.c,$(libgnu_a_SOURCES)))
for_emacs_OBJECTS = $(filter-out $(not_emacs_OBJECTS),$(libgnu_a_OBJECTS))
libegnu_a_OBJECTS = $(patsubst %.o,e-%.o,$(for_emacs_OBJECTS))

$(libegnu_a_OBJECTS) $(libgnu_a_OBJECTS): $(BUILT_SOURCES)

.c.o:
	$(AM_V_CC)$(CC) -c $(CPPFLAGS) $(ALL_CFLAGS) -o $@ $<
e-%.o: %.c
	$(AM_V_CC)$(CC) -c $(CPPFLAGS) $(ALL_CFLAGS) -Demacs -o $@ $<

all: libgnu.a $(if $(HYBRID_MALLOC),libegnu.a)

libgnu.a: $(libgnu_a_OBJECTS)
	$(AM_V_AR)rm -f $@
	$(AM_V_at)$(AR) $(ARFLAGS) $@ $(libgnu_a_OBJECTS)
	$(AM_V_at)$(RANLIB) $@

libegnu.a: $(libegnu_a_OBJECTS)
	$(AM_V_AR)rm -f $@
	$(AM_V_at)$(AR) $(ARFLAGS) $@ $(libegnu_a_OBJECTS)
	$(AM_V_at)$(RANLIB) $@

ETAGS = ../lib-src/etags$(EXEEXT)
$(ETAGS):
	$(MAKE) -C $(dir $@) $(notdir $@)
tagsfiles= $(wildcard $(srcdir)/*.[ch])
tags: TAGS
TAGS: $(ETAGS) $(tagsfiles)
	$(ETAGS) $(tagsfiles)
.PHONY: $(ETAGS) tags

clean:
	rm -f ./*.[ao] ./*/*.o ./*-t \#* $(DEPDIR)/*.d $(DEPDIR)/*/*.d
mostlyclean: clean
	rm -f $(filter-out %-t,$(MOSTLYCLEANFILES))
distclean bootstrap-clean: mostlyclean
	rm -f Makefile
	rm -fr $(DEPDIR)
maintainer-clean: distclean
	rm -f TAGS gnulib.mk
	-rmdir malloc sys 2>/dev/null || true

.PHONY: mostlyclean clean distclean bootstrap-clean maintainer-clean

# Tell versions [3.59,3.63) of GNU make to not export all variables.
# Otherwise a system limit (for SysV at least) may be exceeded.
.NOEXPORT:
